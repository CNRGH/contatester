stages:
  - build
  - test
  - distribute
  - build_image
  - test_image
  - release_image


image: registry.cnrgh.fr/images/sources/python-36-centos7:latest


variables:
  CI_IMAGE:      registry.cnrgh.fr/$CI_PROJECT_NAMESPACE/contatester/contatester:$CI_COMMIT_SHA
  RELEASE_IMAGE: registry.cnrgh.fr/$CI_PROJECT_NAMESPACE/contatester/contatester
  DOCKER_DRIVER: overlay2
  LANG: en_US.UTF-8


build_contatester:
  stage: build
  tags:
    - nodind
  cache:
      key: py_lbi
      untracked: true
  before_script:
    - pip3 install setuptools wheel
    - pip3 install --upgrade pip
    - pip3 install --upgrade wheel
    - pip3 install --upgrade setuptools
  script:
    - cd contatester
    - python3 setup.py clean
    - python3 setup.py build


test_contatester:
  stage: test
  tags:
    - nodind
  cache:
      key: py_lbi
      untracked: true
  before_script:
    - pip3 install setuptools wheel
    - pip3 install --upgrade pip
    - pip3 install --upgrade wheel
    - pip3 install --upgrade setuptools
  script:
    - cd contatester
    - python3 setup.py test


coverage_contatester:
  stage: test
  tags:
    - nodind
  cache:
      key: py_lbi
      untracked: true
  artifacts:
    name: reports
    paths:
      - htmlcov
  before_script:
    - pip3 install setuptools wheel
    - pip3 install --upgrade pip
    - pip3 install --upgrade wheel
    - pip3 install --upgrade setuptools
  script:
    - cd contatester
    - pip3 install coverage
    - python3 setup.py coverage


wheel_contatester:
  stage: distribute
  tags:
    - nodind
  cache:
      key: py_lbi
      untracked: true
  artifacts:
    name: wheel
    paths:
      - dist
  before_script:
    - pip3 install setuptools wheel
    - pip3 install --upgrade pip
    - pip3 install --upgrade wheel
    - pip3 install --upgrade setuptools
  script:
    - cd contatester
    - python3 setup.py bdist_wheel

build_contatester_image:
  stage: build_image
  image: docker
  tags:
    - dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.cnrgh.fr
    - docker ps -a
    - docker stop $(docker ps -a -q -f status=exited)
    - docker rm $(docker ps -a -q -f status=exited)
  script:
    - docker build --pull -t $CI_IMAGE  .
    - docker push $CI_IMAGE

test_contatester_image:
  stage: test_image
  image: docker
  tags:
    - dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.cnrgh.fr
  script:
    - docker pull $CI_IMAGE
    - docker ps -a
    - docker run $CI_IMAGE

release_image:
  stage: test_image
  image: docker
  tags:
    - dind
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.cnrgh.fr
  script:
    - docker pull $CI_IMAGE
    - docker tag $CI_IMAGE $RELEASE_IMAGE:$CI_COMMIT_TAG
    - docker push $RELEASE_IMAGE:$CI_COMMIT_TAG
    - docker tag $CI_IMAGE $RELEASE_IMAGE:latest
    - docker push $RELEASE_IMAGE:latest
  only:
    - tags